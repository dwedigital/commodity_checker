<div class="max-w-7xl mx-auto">
  <!-- Header -->
  <div class="md:flex md:items-center md:justify-between mb-8">
    <div class="min-w-0 flex-1">
      <span class="inline-flex items-center rounded-full bg-brand-dark px-3 py-1 text-xs font-semibold text-white mb-2">ADMIN</span>
      <h2 class="text-2xl font-bold leading-7 text-brand-dark sm:truncate sm:text-3xl sm:tracking-tight">
        Analytics Dashboard
      </h2>
      <p class="mt-1 text-sm text-gray-500">Privacy-first analytics powered by Ahoy</p>
    </div>
    <div class="mt-4 flex md:ml-4 md:mt-0">
      <!-- Period selector -->
      <div class="flex gap-2">
        <% %w[7d 30d 90d 1y].each do |period| %>
          <%= link_to period,
              admin_analytics_path(period: period),
              class: "rounded-full px-4 py-2 text-sm font-medium #{@period == period ? 'bg-brand-dark text-white' : 'bg-white text-brand-dark border border-gray-200 hover:bg-gray-50'} transition-colors" %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Key Metrics -->
  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 mb-8">
    <!-- Visitors -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <dt class="text-sm font-medium text-gray-500">Unique Visitors</dt>
      <dd class="mt-1 text-3xl font-semibold text-brand-dark"><%= number_with_delimiter(@total_visitors) %></dd>
      <p class="mt-1 text-xs text-gray-400"><%= number_with_delimiter(@total_visits) %> total visits</p>
    </div>

    <!-- Lookups -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <dt class="text-sm font-medium text-gray-500">Total Lookups</dt>
      <dd class="mt-1 text-3xl font-semibold text-brand-dark"><%= number_with_delimiter(@total_lookups) %></dd>
      <p class="mt-1 text-xs text-gray-400">Across all sources</p>
    </div>

    <!-- Signups -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <dt class="text-sm font-medium text-gray-500">New Signups</dt>
      <dd class="mt-1 text-3xl font-semibold text-brand-dark"><%= number_with_delimiter(@total_signups) %></dd>
      <p class="mt-1 text-xs text-gray-400"><%= @signup_conversion_rate %>% conversion rate</p>
    </div>

    <!-- Active Users -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <dt class="text-sm font-medium text-gray-500">Active Users</dt>
      <dd class="mt-1 text-3xl font-semibold text-brand-dark"><%= number_with_delimiter(@active_users) %></dd>
      <p class="mt-1 text-xs text-gray-400"><%= @repeat_users %> repeat users</p>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-6 lg:grid-cols-2 mb-8">
    <!-- Visitors Chart -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-brand-dark mb-4">Visitors Over Time</h3>
      <% if @visitors_by_day.any? %>
        <div class="h-48" data-controller="simple-chart" data-simple-chart-data-value="<%= @visitors_by_day.to_json %>" data-simple-chart-color-value="#2D1E2F">
          <canvas data-simple-chart-target="canvas"></canvas>
        </div>
      <% else %>
        <p class="text-gray-500 text-sm">No visitor data for this period</p>
      <% end %>
    </div>

    <!-- Lookups Chart -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-brand-dark mb-4">Lookups Over Time</h3>
      <% if @lookups_by_day.any? %>
        <div class="h-48" data-controller="simple-chart" data-simple-chart-data-value="<%= @lookups_by_day.to_json %>" data-simple-chart-color-value="#E3170A">
          <canvas data-simple-chart-target="canvas"></canvas>
        </div>
      <% else %>
        <p class="text-gray-500 text-sm">No lookup data for this period</p>
      <% end %>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-6 lg:grid-cols-3 mb-8">
    <!-- Lookups by Source -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-brand-dark mb-4">Lookups by Source</h3>
      <dl class="space-y-3">
        <% @lookups_by_source.each do |source, count| %>
          <div class="flex items-center justify-between">
            <dt class="text-sm text-gray-600"><%= source %></dt>
            <dd class="text-sm font-semibold text-brand-dark"><%= number_with_delimiter(count) %></dd>
          </div>
          <div class="w-full bg-gray-100 rounded-full h-2">
            <% percentage = @total_lookups > 0 ? (count.to_f / @total_lookups * 100) : 0 %>
            <div class="bg-primary h-2 rounded-full" style="width: <%= percentage %>%"></div>
          </div>
        <% end %>
      </dl>
    </div>

    <!-- Top Referrers -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-brand-dark mb-4">Top Referrers</h3>
      <% if @top_referrers.any? %>
        <dl class="space-y-2">
          <% @top_referrers.each do |domain, count| %>
            <div class="flex items-center justify-between">
              <dt class="text-sm text-gray-600 truncate max-w-[180px]"><%= domain %></dt>
              <dd class="text-sm font-semibold text-brand-dark"><%= number_with_delimiter(count) %></dd>
            </div>
          <% end %>
        </dl>
      <% else %>
        <p class="text-gray-500 text-sm">No referrer data</p>
      <% end %>
    </div>

    <!-- Device Breakdown -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-brand-dark mb-4">Devices</h3>
      <dl class="space-y-3">
        <% @devices.each do |device, count| %>
          <div class="flex items-center justify-between">
            <dt class="text-sm text-gray-600 capitalize"><%= device %></dt>
            <dd class="text-sm font-semibold text-brand-dark"><%= number_with_delimiter(count) %></dd>
          </div>
          <div class="w-full bg-gray-100 rounded-full h-2">
            <% percentage = @total_visits > 0 ? (count.to_f / @total_visits * 100) : 0 %>
            <div class="bg-brand-mint h-2 rounded-full" style="width: <%= percentage %>%"></div>
          </div>
        <% end %>
      </dl>
    </div>
  </div>

  <!-- Additional Stats -->
  <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
    <!-- Signups Over Time -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-brand-dark mb-4">Signups Over Time</h3>
      <% if @signups_by_day.any? %>
        <div class="h-48" data-controller="simple-chart" data-simple-chart-data-value="<%= @signups_by_day.to_json %>" data-simple-chart-color-value="#A9E5BB">
          <canvas data-simple-chart-target="canvas"></canvas>
        </div>
      <% else %>
        <p class="text-gray-500 text-sm">No signup data for this period</p>
      <% end %>
      <p class="mt-4 text-sm text-gray-500">
        <span class="font-semibold"><%= @total_users_created %></span> users created in database
        <% if @total_users_created != @total_signups %>
          <span class="text-xs text-gray-400">(event tracking may have started later)</span>
        <% end %>
      </p>
    </div>

    <!-- Usage Insights -->
    <div class="bg-white rounded-2xl border border-gray-200 p-6">
      <h3 class="text-lg font-semibold text-brand-dark mb-4">Usage Insights</h3>
      <dl class="space-y-4">
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <dt class="text-sm text-gray-600">Avg lookups per active user</dt>
          <dd class="text-lg font-semibold text-brand-dark"><%= @avg_lookups_per_user %></dd>
        </div>
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <dt class="text-sm text-gray-600">Users with 2+ lookups</dt>
          <dd class="text-lg font-semibold text-brand-dark"><%= number_with_delimiter(@repeat_users) %></dd>
        </div>
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <dt class="text-sm text-gray-600">Guest limit reached events</dt>
          <dd class="text-lg font-semibold text-brand-dark"><%= number_with_delimiter(@guest_limits_reached) %></dd>
        </div>
        <div class="flex items-center justify-between py-2">
          <dt class="text-sm text-gray-600">Visitor to signup rate</dt>
          <dd class="text-lg font-semibold text-brand-dark"><%= @signup_conversion_rate %>%</dd>
        </div>
      </dl>
    </div>
  </div>
</div>
